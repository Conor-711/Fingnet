<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Extension Auth Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .section {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .section h3 {
      margin-top: 0;
      color: #667eea;
    }
    .status {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    pre {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    .badge.success {
      background: #48bb78;
      color: white;
    }
    .badge.warning {
      background: #ed8936;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª Extension Auth Test</h1>
    <p class="subtitle">æ¨¡æ‹Ÿ Chrome æ’ä»¶çš„ç™»å½•æµç¨‹</p>

    <!-- Step 1: æ‰“å¼€ç™»å½•çª—å£ -->
    <div class="section">
      <h3>Step 1: æ‰“å¼€ç™»å½•çª—å£</h3>
      <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ¨¡æ‹Ÿæ’ä»¶æ‰“å¼€ç™»å½•çª—å£</p>
      <button id="openLoginBtn" onclick="openLoginWindow()">
        ğŸš€ Open Login Window
      </button>
      <div id="loginStatus"></div>
    </div>

    <!-- Step 2: ç›‘å¬ç™»å½•ç»“æœ -->
    <div class="section">
      <h3>Step 2: ç™»å½•ç»“æœ</h3>
      <p>ç­‰å¾…ç™»å½•çª—å£è¿”å›æ•°æ®...</p>
      <div id="authResult"></div>
      <div id="userData"></div>
    </div>

    <!-- Step 3: æµ‹è¯• API -->
    <div class="section">
      <h3>Step 3: æµ‹è¯• API è°ƒç”¨</h3>
      <button id="getProfileBtn" onclick="getProfile()" disabled>
        ğŸ“‹ Get Profile
      </button>
      <button id="updateProfileBtn" onclick="updateProfile()" disabled>
        âœï¸ Update Profile
      </button>
      <button id="refreshTokenBtn" onclick="refreshToken()" disabled>
        ğŸ”„ Refresh Token
      </button>
      <div id="apiResult"></div>
    </div>

    <!-- Step 4: å­˜å‚¨çš„æ•°æ® -->
    <div class="section">
      <h3>Step 4: æœ¬åœ°å­˜å‚¨</h3>
      <button onclick="showStoredData()">
        ğŸ’¾ Show Stored Data
      </button>
      <button onclick="clearStoredData()">
        ğŸ—‘ï¸ Clear Storage
      </button>
      <div id="storageData"></div>
    </div>
  </div>

  <script>
    let loginWindow = null;
    let sessionData = null;
    let profileData = null;

    // ä» localStorage æ¢å¤æ•°æ®
    function restoreSession() {
      const stored = localStorage.getItem('fingnet_test_session');
      if (stored) {
        try {
          const data = JSON.parse(stored);
          sessionData = data.session;
          profileData = data.profile;
          
          if (sessionData) {
            document.getElementById('getProfileBtn').disabled = false;
            document.getElementById('updateProfileBtn').disabled = false;
            document.getElementById('refreshTokenBtn').disabled = false;
            
            showStatus('loginStatus', 'info', 'âœ… å·²æ¢å¤ä¹‹å‰çš„ç™»å½•ä¼šè¯');
          }
        } catch (e) {
          console.error('Failed to restore session:', e);
        }
      }
    }

    // æ‰“å¼€ç™»å½•çª—å£
    function openLoginWindow() {
      const extensionId = 'test-extension-id';
      const baseUrl = window.location.origin;
      const loginUrl = `${baseUrl}/auth/extension-login?source=extension&ext_id=${extensionId}`;
      
      console.log('ğŸ”— Opening login URL:', loginUrl);
      
      // æ‰“å¼€æ–°çª—å£
      loginWindow = window.open(
        loginUrl,
        'FingnetLogin',
        'width=500,height=700,menubar=no,toolbar=no,location=no'
      );

      if (loginWindow) {
        showStatus('loginStatus', 'info', 'âœ… ç™»å½•çª—å£å·²æ‰“å¼€ï¼Œç­‰å¾…ç”¨æˆ·å®Œæˆç™»å½•...');
        document.getElementById('openLoginBtn').disabled = true;
      } else {
        showStatus('loginStatus', 'error', 'âŒ æ— æ³•æ‰“å¼€ç™»å½•çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®');
      }
    }

    // ç›‘å¬æ¥è‡ªç™»å½•çª—å£çš„æ¶ˆæ¯
    window.addEventListener('message', (event) => {
      console.log('ğŸ“¨ Received message:', event);

      // å®‰å…¨æ£€æŸ¥ï¼šéªŒè¯æ¥æº
      const allowedOrigins = [
        window.location.origin,
        'http://localhost:8080',
        'https://fingnet.xyz'
      ];

      if (!allowedOrigins.includes(event.origin)) {
        console.warn('âš ï¸ å¿½ç•¥æ¥è‡ªæœªçŸ¥æ¥æºçš„æ¶ˆæ¯:', event.origin);
        return;
      }

      const { type, session, profile, aiTwin, needsOnboarding, isFirstLogin } = event.data;

      if (type === 'FINGNET_AUTH_SUCCESS') {
        console.log('âœ… ç™»å½•æˆåŠŸï¼');
        
        // ä¿å­˜æ•°æ®
        sessionData = session;
        profileData = profile;

        // å­˜å‚¨åˆ° localStorage
        localStorage.setItem('fingnet_test_session', JSON.stringify({
          session,
          profile,
          aiTwin,
          needsOnboarding,
          isFirstLogin
        }));

        // å¯ç”¨ API æµ‹è¯•æŒ‰é’®
        document.getElementById('getProfileBtn').disabled = false;
        document.getElementById('updateProfileBtn').disabled = false;
        document.getElementById('refreshTokenBtn').disabled = false;
        document.getElementById('openLoginBtn').disabled = false;

        // æ˜¾ç¤ºç»“æœ
        showStatus('authResult', 'success', 'âœ… ç™»å½•æˆåŠŸï¼');
        
        const userInfo = `
          <div style="margin-top: 15px;">
            <h4>ç”¨æˆ·ä¿¡æ¯:</h4>
            <p><strong>Email:</strong> ${profile.email}</p>
            <p><strong>Name:</strong> ${profile.name}</p>
            <p><strong>ID:</strong> ${profile.id}</p>
            ${needsOnboarding ? '<span class="badge warning">éœ€è¦ Onboarding</span>' : '<span class="badge success">å·²å®Œæˆ Onboarding</span>'}
            ${isFirstLogin ? '<span class="badge warning">é¦–æ¬¡ç™»å½•</span>' : ''}
            ${aiTwin ? `<p><strong>AI Twin:</strong> ${aiTwin.name}</p>` : ''}
          </div>
          <pre>${JSON.stringify({ profile, aiTwin, needsOnboarding, isFirstLogin }, null, 2)}</pre>
        `;
        
        document.getElementById('userData').innerHTML = userInfo;

        // å…³é—­ç™»å½•çª—å£ï¼ˆå¦‚æœè¿˜å¼€ç€ï¼‰
        if (loginWindow && !loginWindow.closed) {
          setTimeout(() => {
            loginWindow.close();
          }, 2000);
        }

      } else if (type === 'FINGNET_AUTH_ERROR') {
        console.error('âŒ ç™»å½•å¤±è´¥:', event.data.error);
        showStatus('authResult', 'error', `âŒ ç™»å½•å¤±è´¥: ${event.data.error}`);
        document.getElementById('openLoginBtn').disabled = false;
      }
    });

    // è·å–ç”¨æˆ·èµ„æ–™
    async function getProfile() {
      if (!sessionData) {
        showStatus('apiResult', 'error', 'âŒ è¯·å…ˆç™»å½•');
        return;
      }

      try {
        showStatus('apiResult', 'info', 'â³ æ­£åœ¨è·å–ç”¨æˆ·èµ„æ–™...');

        // è°ƒç”¨çœŸå®çš„ API
        const baseUrl = window.location.origin;
        const apiUrl = `${baseUrl}/api/extension?action=profile&token=${sessionData.access_token}`;
        
        const response = await fetch(apiUrl);
        const result = await response.json();

        if (result.success) {
          showStatus('apiResult', 'success', 'âœ… è·å–æˆåŠŸ');
          document.getElementById('apiResult').innerHTML += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
        } else {
          throw new Error(result.error || 'Failed to get profile');
        }
      } catch (error) {
        showStatus('apiResult', 'error', `âŒ è·å–å¤±è´¥: ${error.message}`);
      }
    }

    // æ›´æ–°ç”¨æˆ·èµ„æ–™
    async function updateProfile() {
      if (!sessionData) {
        showStatus('apiResult', 'error', 'âŒ è¯·å…ˆç™»å½•');
        return;
      }

      const newName = prompt('è¾“å…¥æ–°çš„åå­—:', profileData?.name || '');
      if (!newName) return;

      try {
        showStatus('apiResult', 'info', 'â³ æ­£åœ¨æ›´æ–°ç”¨æˆ·èµ„æ–™...');

        // è°ƒç”¨çœŸå®çš„ API
        const baseUrl = window.location.origin;
        const apiUrl = `${baseUrl}/api/extension?action=update&token=${sessionData.access_token}&name=${encodeURIComponent(newName)}`;
        
        const response = await fetch(apiUrl);
        const result = await response.json();

        if (result.success) {
          profileData = result.data;
          
          // æ›´æ–°å­˜å‚¨
          const stored = JSON.parse(localStorage.getItem('fingnet_test_session') || '{}');
          stored.profile = profileData;
          localStorage.setItem('fingnet_test_session', JSON.stringify(stored));

          showStatus('apiResult', 'success', `âœ… æ›´æ–°æˆåŠŸï¼æ–°åå­—: ${newName}`);
          document.getElementById('apiResult').innerHTML += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
        } else {
          throw new Error(result.error || 'Failed to update profile');
        }
      } catch (error) {
        showStatus('apiResult', 'error', `âŒ æ›´æ–°å¤±è´¥: ${error.message}`);
      }
    }

    // åˆ·æ–° Token
    async function refreshToken() {
      if (!sessionData) {
        showStatus('apiResult', 'error', 'âŒ è¯·å…ˆç™»å½•');
        return;
      }

      try {
        showStatus('apiResult', 'info', 'â³ æ­£åœ¨åˆ·æ–° Token...');

        // è°ƒç”¨çœŸå®çš„ API
        const baseUrl = window.location.origin;
        const apiUrl = `${baseUrl}/api/extension?action=refresh&refresh_token=${sessionData.refresh_token}`;
        
        const response = await fetch(apiUrl);
        const result = await response.json();

        if (result.success) {
          sessionData = result.session;
          
          // æ›´æ–°å­˜å‚¨
          const stored = JSON.parse(localStorage.getItem('fingnet_test_session') || '{}');
          stored.session = sessionData;
          localStorage.setItem('fingnet_test_session', JSON.stringify(stored));

          showStatus('apiResult', 'success', 'âœ… Token åˆ·æ–°æˆåŠŸï¼');
          document.getElementById('apiResult').innerHTML += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
        } else {
          throw new Error(result.error || 'Failed to refresh token');
        }
      } catch (error) {
        showStatus('apiResult', 'error', `âŒ åˆ·æ–°å¤±è´¥: ${error.message}`);
      }
    }

    // æ˜¾ç¤ºå­˜å‚¨çš„æ•°æ®
    function showStoredData() {
      const stored = localStorage.getItem('fingnet_test_session');
      if (stored) {
        const data = JSON.parse(stored);
        document.getElementById('storageData').innerHTML = `
          <h4>å­˜å‚¨çš„æ•°æ®:</h4>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
      } else {
        document.getElementById('storageData').innerHTML = `
          <p style="color: #666;">æš‚æ— å­˜å‚¨æ•°æ®</p>
        `;
      }
    }

    // æ¸…é™¤å­˜å‚¨
    function clearStoredData() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å­˜å‚¨çš„æ•°æ®å—ï¼Ÿ')) {
        localStorage.removeItem('fingnet_test_session');
        sessionData = null;
        profileData = null;
        
        document.getElementById('getProfileBtn').disabled = true;
        document.getElementById('updateProfileBtn').disabled = true;
        document.getElementById('refreshTokenBtn').disabled = true;
        
        document.getElementById('storageData').innerHTML = '';
        document.getElementById('userData').innerHTML = '';
        document.getElementById('authResult').innerHTML = '';
        
        showStatus('storageData', 'success', 'âœ… å­˜å‚¨å·²æ¸…é™¤');
      }
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(elementId, type, message) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    // é¡µé¢åŠ è½½æ—¶æ¢å¤ä¼šè¯
    window.addEventListener('load', restoreSession);
  </script>
</body>
</html>
